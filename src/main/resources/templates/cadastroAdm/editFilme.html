<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Cinema - Cliente</title>
    <link rel="stylesheet" href="./../../css/global.css">
    <link rel="stylesheet" href="./../../css/home.css">
    <link rel="stylesheet" href="./../../css/menu.css">
    <link rel="stylesheet" href="./../../css/generalHome.css">
    <link rel="stylesheet" href="./../../css/formsNewFilm.css">
    <link rel="stylesheet" href="./../../css/editFilmStyles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
          integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100,200,300,400,500,600,700,800,900;1,100,200,300,400,500,600,700,800,900&display=swap"
            rel="stylesheet">
</head>

<body class="body">
<nav class="container-menu">
    <div class="buttonsAreaView">
        <div class="buttonView active"><button><a th:href="@{/cadastroAdm/cadNewFilme}">
            <i class="fa-solid fa-circle-plus"></i></a></button>
            <p>Adicionar Filme</p>
        </div>
        <div class="buttonView"><button><a th:href="@{/cadastroAdm/addActorPage}"><i class="fa-solid fa-user-plus"></i></a></button>
            <p>Adicionar Atores</p>
        </div>
        <div class="buttonView"><button><a href=""><i class="fa-solid fa-right-from-bracket"></i></a></button>
            <p>Logout</p>
        </div>

    </div>
</nav>
<main class="container">
    <!-- titulo do formulario -->
    <div class="cockpit_filmes_form">
        <div class="cockpit_item_adm ">
            <button class="btn_return"><a href="/cadastroAdm/index"><i class="fa-solid fa-arrow-left"></i></a></button>
            <h1>Capas & Banners</h1>
        </div>
    </div>

    <!-- campos do formulario -->
    <form class="div_security_area"
          th:action="@{/cadastroAdm/editFilme/{id}(id=${filme.id})}"
          method="post"
          enctype="multipart/form-data">
        <!-- banners -->
        <div class="inputs_area">
            <div class="input_div">
                <label>Capa principal</label>
                <label class="input_capas">
                    <img th:src="'data:image/jpeg;base64,' + ${filme.imagemBase64}" alt="Clique para selecionar uma imagem" id="imagePreview1">
                    <!-- Campo de input de arquivo escondido -->
                    <input type="file" name="dados" class="banners" id="file-input1"  accept="image/*">
                </label>

                <!-- <label class="input_capas"> <input type="file" accept="image/*" class="principal"></label> -->
            </div>
            <div class="input_div">
                <label>Banner principal</label>
                <label class="input_capas">
                    <img th:src="'data:image/jpeg;base64,' + ${filme.imagemBanner64}" alt="Clique para selecionar uma imagem" id="imagePreview2">
                    <!-- Campo de input de arquivo escondido -->
                    <input type="file" name="dados_banner" class="banners" id="file-input2"  accept="image/*">
                </label>

            </div>
        </div>

        <!-- campos -->
        <div class="inputs_area linear">
            <h1> Informações</h1>
            <div class="div_list_inputs">
                <div class="input_div_grid">
                    <label>Nome</label>
                    <label class="input_capas"> <input name="nomeFilme" type="text" th:value="${filme.nomeFilme}"></label>
                </div>
<!--                <div class="input_div_grid">-->
<!--                    <label>Categoria</label>-->
<!--                    <label class="input_capas">-->
<!--                        <select id="cate" name="categoria" class="principal">-->
<!--                            <option value="acao">Ação</option>-->
<!--                            <option value="aventura">Aventura</option>-->
<!--                            <option value="comedia">Comédia</option>-->
<!--                            <option value="drama">Drama</option>-->
<!--                            <option value="terror">Terror</option>-->
<!--                            <option value="ficcao-cientifica">Ficção Científica</option>-->
<!--                            <option value="romance">Romance</option>-->
<!--                            <option value="fantasia">Fantasia</option>-->
<!--                            <option value="suspense">Suspense</option>-->
<!--                            <option value="misterio">Mistério</option>-->
<!--                            <option value="animacao">Animação</option>-->
<!--                            <option value="documentario">Documentário</option>-->
<!--                            <option value="musical">Musical</option>-->
<!--                            <option value="historico">Histórico</option>-->
<!--                            <option value="familia">Família</option>-->
<!--                        </select>-->
<!--                    </label>-->
<!--                </div>-->
                <div class="input_div_grid">
                    <label>Ano de Lançamento</label>
                    <label class="input_capas"> <input name="dataLancamento" type="date" th:value="${filme.dataLancamento}"></label>
                </div>
                <div class="input_div_grid">
                    <label>Avaliações</label>
                    <label class="input_capas"> <input type="text" name="avaliacao" th:value="${filme.avaliacao}"></label>
                </div>
                <div class="input_div_grid">
                    <label>Tempo de duração <span style="font-size: 0.7rem;color: #cccccc65;">(exemplo: 120
                                min)</span></label>
                    <label class="input_capas"> <input type="text" name="duracao" th:value="${filme.duracao}"></label>
                </div>
                <div class="input_div_grid">
                    <label>Restrição de idade</label>
                    <label class="input_capas">
                        <select id="rest" name="classificacaoIndicativa" class="principal">
                            <option value="0"
                                    th:selected="${filme.classificacaoIndicativa == 0}">
                                Livre
                            </option>

                            <option value="12"
                                    th:selected="${filme.classificacaoIndicativa == 12}">
                                +12
                            </option>

                            <option value="14"
                                    th:selected="${filme.classificacaoIndicativa == 14}">
                                +14
                            </option>

                            <option value="16"
                                    th:selected="${filme.classificacaoIndicativa == 16}">
                                +16
                            </option>

                            <option value="18"
                                    th:selected="${filme.classificacaoIndicativa == 18}">
                                +18
                            </option>
                        </select>
                    </label>

                </div>
                <div class="input_div_grid desc_area">
                    <label>Descrição</label>
                    <label class="input_capas"> <textarea class="descr_input" name="descricao" th:text="${filme.descricao}" ></textarea></label>
                </div>
            </div>
        </div>
        <!-- ABRIR MODAL PARA SELECIONAR ATORES -->
        <div class="add_atores">
            <h3>Atores Principais</h3>
        </div>
        <button class="add_btn_Actor" type="button" onclick="openCloseModal('.modal_add_ator')">Adicionar Ator</button>
        <div class="div_list_inputs actors">
            <div th:replace="~{fragments/layoutAtores :: layout(${atoresDoFilme})}"></div>

        </div>

        <!-- atores -->
        <div class="div_list_inputs actors">


        <div class="footer">
            <div class="footer_container_area with_delete_button">
                <button class="delete_btn" type="button" onclick="deletarFilme()">
                    Excluir
                </button>

                <div class="others">
                    <button class="cancel_btn" type="button" onclick="history.back()">
                        Cancelar
                    </button>

                    <button class="add_btn" type="submit">
                        Editar
                    </button>
                </div>
            </div>
        </div>    </div>

    </form>
    <div id="filme" th:data-id="${filme.id}"></div>

</main>



<div class="modal modal_add_ator hidden">
    <div class="modal_header">
        <p>Adicionar ator</p>
        <button class="close" data-modal-close>X</button>
    </div>

    <div class="modal_content">
        <form>

            <label class="nome_ficticio_label">
                <span>Nome fictício</span>
                <input type="text" class="input_style" id="nome_ficticio" name="nome_ficticio" placeholder="Nome do personagem">
            </label>

            <div class="search">
                <div class="action">
                    <input type="text" class="input_style" id="filtro_ator" placeholder="Filtrar por nome">
                </div>
            </div>

            <div class="container_actores_list">

                <!-- LOOP DOS ATORES -->
                <div class="actors_div_film"
                     th:each="ator : ${listaAtores}"
                     th:data-nome="${ator.nomeAtor}">

                    <input type="radio"
                           th:id="'ator_' + ${ator.id}"
                           name="selected_actor"
                           th:value="${ator.id}"
                           required>

                    <label class="label_input_radio"
                           th:for="'ator_' + ${ator.id}">

                        <img th:src="${ator.fotoBase64}" alt="Foto do ator">

                        <div class="content">

                            <!-- Nome real do ator -->
                            <p class="title_actor_name location"
                               th:text="${ator.nomeAtor}">
                                Nome do Ator
                            </p>
                        </div>
                    </label>

                </div>

            </div>

            <div class="submit">
                <button class="add_btn_Actor " type="button" onclick="addAtorFilme()">
                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                    Adicionar
                </button>
            </div>

        </form>
    </div>
</div>




<script src="../scriptGlobal.js"></script>
<script src="https://kit.fontawesome.com/3d5034d18d.js" crossorigin="anonymous"></script>
<script>
    function openCloseModal(selector) {
        const modal = document.querySelector(selector);
        if (!modal) {
            console.error("Modal não encontrado:", selector);
            return;
        }
        modal.classList.toggle("hidden");
    }
</script>
<script>
    document.addEventListener("click", function(e){
        if (e.target.hasAttribute("data-modal-close")) {
            openCloseModal(".modal_add_ator");
        }
    });
</script>


<script>

    const form = document.getElementById('formUpload');
    const fileInput = document.getElementById('file-input');

 fileInput.addEventListener('change', async () => {
     const formData = new FormData(form);

     try {
         const response = await fetch(form.action, {
             method: 'POST',
             body: formData
         })

         if (response.ok) {
             console.log('Imagem enviada com sucesso!');
         } else {
             console.error('Erro ao enviar imagem');
         }
     } catch (err) {
         console.error('Erro na requisição:', err);
     }
 })
</script>
<script>
    async function addAtorFilme() {

        const papel = document.getElementById("nome_ficticio").value;
        const atorRadio = document.querySelector("input[name='selected_actor']:checked");

        if (!atorRadio) {
            alert("Selecione um ator.");
            return;
        }

        const atorId = atorRadio.value;
        const filmeId = /* Thymeleaf injeta o ID aqui */ [[${filme.id}]];

        const formData = new URLSearchParams();
        formData.append("filmeId", filmeId);
        formData.append("atorId", atorId);
        formData.append("papel", papel);

        const response = await fetch("/cadastroAdm/addAtorFilme", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData
        });

        if (response.ok) {
            alert("Ator adicionado com sucesso!");

            // Fechar modal
            openCloseModal('.modal_add_ator');

            // Atualizar lista de atores na tela sem reload
            loadAtoresDoFilme(filmeId);

        } else {
            alert("Erro ao adicionar ator.");
        }
    }
</script>
<script>
    async function loadAtoresDoFilme(filmeId) {

        const response = await fetch(`/cadastroAdm/listaAtoresFilme/${filmeId}`);
        const html = await response.text();

        document.querySelector(".actors .container_actores_list")
                .innerHTML = html;
    }
</script>
<script>
    async function deletarFilme() {

     const id = document.getElementById("filme").dataset.id;

     if (!confirm("Tem certeza?")) return;

     const resp = await fetch(`/cadastroAdm/deleteFilme/${id}`, {
         method: "POST"
     });

     if (resp.ok) {
         window.location.href = "/cadastroAdm/index";
     } else {
         alert("Erro ao excluir!");
     }
 }

</script>

</body>
</html>

